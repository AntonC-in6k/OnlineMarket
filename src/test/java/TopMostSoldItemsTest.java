import dao.*;
import entity.*;
import org.junit.Before;
import org.junit.Test;

import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.HashMap;

import static org.hamcrest.CoreMatchers.is;
import static org.junit.Assert.assertThat;

/**
 * Created by Mr_Blame on 24.07.2016.
 */
public class TopMostSoldItemsTest {
    private SqlConnectionForTestImpl sqlConnectionForTest;
    private CategoryDao categoryDao;
    private ItemsDao itemsDao;
    private PurchaseDao purchaseDao;
    private CustomerDao customerDao;
    private ItemsInPurchaseDao itemsInPurchaseDao;


    @Before
    public void init() throws Exception {
        sqlConnectionForTest = new SqlConnectionForTestImpl();
        createTables(sqlConnectionForTest.getConnection());
        purchaseDao = new PurchaseDao(sqlConnectionForTest.getConnection());
        customerDao = new CustomerDao(sqlConnectionForTest.getConnection());
        categoryDao = new CategoryDao(sqlConnectionForTest.getConnection());
        itemsDao = new ItemsDao(sqlConnectionForTest.getConnection());
        itemsInPurchaseDao = new ItemsInPurchaseDao(sqlConnectionForTest.getConnection());
        createDataForTables();
    }

    private void createTables(Connection connection)
            throws SQLException {
        PreparedStatement statement = connection.prepareStatement(
                "CREATE TABLE Categories" +
                        "(CategoryId int not null GENERATED BY DEFAULT AS IDENTITY, " +
                        "Name varchar(100), PRIMARY KEY(CategoryId))");
        statement.executeUpdate();
        statement = connection.prepareStatement(
                "CREATE TABLE Customers" +
                        "(CustomerId int not null GENERATED BY DEFAULT AS IDENTITY, " +
                        "CustomerName varchar(100) not null, " +
                        "PRIMARY KEY (CustomerId));");
        statement.executeUpdate();
        statement = connection.prepareStatement(
                "CREATE TABLE Purchases" +
                        "(PurchaseId int not null GENERATED BY DEFAULT AS IDENTITY, CustomerId int, " +
                        "DateTime TIMESTAMP, Cost decimal(7,2), PRIMARY KEY(PurchaseId))");
        statement.executeUpdate();
        statement = connection.prepareStatement(
                "CREATE TABLE Items" +
                        "(ItemId int not null GENERATED BY DEFAULT AS IDENTITY, " +
                        "ItemName varchar(100) not null, CategoryId int not null, " +
                        "Cost decimal(7,2) not null, " +
                        "PRIMARY KEY (ItemId), FOREIGN KEY (CategoryId) " +
                        "REFERENCES Categories(CategoryId));");
        statement.executeUpdate();
        statement = connection.prepareStatement(
                "CREATE TABLE ItemsInPurchase" +
                        "(PurchaseId int not null, ItemId int not null, " +
                        "ItemsNumber int not null, Price decimal(7,2) not null, " +
                        "FOREIGN KEY (ItemId) REFERENCES Items(ItemId), " +
                        "FOREIGN KEY (PurchaseId) REFERENCES Purchases(PurchaseId));");
        statement.executeUpdate();

        statement.close();
    }

    private void createDataForTables() throws SQLException {
        createCustomers();
        createPurchases();
        createCategories();
        createItems();
        createItemsInPurchase();
    }

    private void createCustomers() throws SQLException {
        Customer customer = new Customer();
        customer.setName("Anton");
        customerDao.create(customer);
        customer = new Customer();
        customer.setName("Karl");
        customerDao.create(customer);
    }

    private void createPurchases() throws SQLException {
        Purchase purchase = new Purchase();
        purchase.setCustomerId(0);
        purchase.setLocalDateTime(LocalDateTime.of(2016, 7, 10, 14, 04, 1));
        purchase.setCost(BigDecimal.valueOf(50.5));
        purchaseDao.create(purchase);


        purchase = new Purchase();
        purchase.setCustomerId(1);
        purchase.setLocalDateTime(LocalDateTime.of(2016, 4, 6, 14, 04, 1));
        purchase.setCost(BigDecimal.valueOf(10.0));
        purchaseDao.create(purchase);

    }

    private void createCategories() throws SQLException {
        Category testCategory = new Category();
        testCategory.setCategoryName("Mobile phone");
        categoryDao.create(testCategory);
        testCategory = new Category();
        testCategory.setCategoryName("Laptops");
        categoryDao.create(testCategory);
    }

    private void createItems() throws SQLException {
        Item testItem = new Item();
        testItem.setItemName("Iphone");
        testItem.setCategoryId(0);
        testItem.setCost(BigDecimal.valueOf(600.00));

        itemsDao.create(testItem);
        testItem = new Item();
        testItem.setItemName("Samsung Galaxy");
        testItem.setCategoryId(0);
        testItem.setCost(BigDecimal.valueOf(400.00));
        itemsDao.create(testItem);

        testItem = new Item();
        testItem.setItemName("Samsung NOTE");
        testItem.setCategoryId(0);
        testItem.setCost(BigDecimal.valueOf(500.00));
        itemsDao.create(testItem);

        testItem = new Item();
        testItem.setItemName("HTC One");
        testItem.setCategoryId(0);
        testItem.setCost(BigDecimal.valueOf(5500.00));
        itemsDao.create(testItem);

        testItem = new Item();
        testItem.setItemName("Lenovo z500");
        testItem.setCategoryId(1);
        testItem.setCost(BigDecimal.valueOf(500.00));
        itemsDao.create(testItem);
    }

    private void createItemsInPurchase() throws SQLException {

        ItemsInPurchase itemsInPurchase = new ItemsInPurchase();
        itemsInPurchase.setPurchaseId(0);
        itemsInPurchase.setItemId(0);
        itemsInPurchase.setItemsNumber(5);
        itemsInPurchase.setPrice(BigDecimal.valueOf(1800.00));
        itemsInPurchaseDao.create(itemsInPurchase);

        itemsInPurchase = new ItemsInPurchase();
        itemsInPurchase.setPurchaseId(0);
        itemsInPurchase.setItemId(1);
        itemsInPurchase.setItemsNumber(4);
        itemsInPurchase.setPrice(BigDecimal.valueOf(1000.00));
        itemsInPurchaseDao.create(itemsInPurchase);

        itemsInPurchase = new ItemsInPurchase();
        itemsInPurchase.setPurchaseId(0);
        itemsInPurchase.setItemId(2);
        itemsInPurchase.setItemsNumber(10);
        itemsInPurchase.setPrice(BigDecimal.valueOf(1500.00));
        itemsInPurchaseDao.create(itemsInPurchase);

        itemsInPurchase = new ItemsInPurchase();
        itemsInPurchase.setPurchaseId(0);
        itemsInPurchase.setItemId(3);
        itemsInPurchase.setItemsNumber(12);
        itemsInPurchase.setPrice(BigDecimal.valueOf(2000.00));
        itemsInPurchaseDao.create(itemsInPurchase);
    }

    @Test
    public void Top3MostSoldItemsTest() throws Exception {
        HashMap<Integer, Integer> testHashMap = new HashMap<>();
        testHashMap.put(0,5);
        testHashMap.put(2,10);
        testHashMap.put(3,12);
        LocalDateTime.of(2016, 7, 10, 14, 04, 1);
        assertThat(itemsDao.getTopThreeSoldItemsInCategory(0,LocalDateTime.of(2016, 7, 22, 14, 04, 1)),
                is(testHashMap));

    }
}
